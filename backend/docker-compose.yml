services:
  # Databases
  auth-db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: authdb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5432:5432"

  faculty-db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: facultydb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5433:5432"

  student-db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: studentdb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5434:5432"

  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    ports:
      - "5672:5672"
      - "15672:15672"

  # Microservices
  auth-service:
    build: ./Authentication-Service
    environment:
      DATABASE_URL: jdbc:postgresql://auth-db:5432/authdb
      DATABASE_USERNAME: postgres
      DATABASE_PASSWORD: postgres
      JWT_SECRET: ${JWT_SECRET}
    ports:
      - "8070:8070"
    depends_on:
      - auth-db

  faculty-service:
    build: ./FacultyService
    environment:
      DATABASE_URL: jdbc:postgresql://faculty-db:5432/facultydb
      DATABASE_USERNAME: postgres
      DATABASE_PASSWORD: postgres
      RABBITMQ_HOST: rabbitmq
      AUTH_SERVICE_URL: http://auth-service:8070
      STUDENT_SERVICE_URL: http://student-service:8084
    ports:
      - "8080:8080"
    depends_on:
      - faculty-db
      - rabbitmq

  student-service:
    build: ./StudentService
    environment:
      DATABASE_URL: jdbc:postgresql://student-db:5432/studentdb
      DATABASE_USERNAME: postgres
      DATABASE_PASSWORD: postgres
      RABBITMQ_HOST: rabbitmq
      CLOUDINARY_CLOUD_NAME: ${CLOUDINARY_CLOUD_NAME}
      CLOUDINARY_API_KEY: ${CLOUDINARY_API_KEY}
      CLOUDINARY_API_SECRET: ${CLOUDINARY_API_SECRET}
      AUTH_SERVICE_URL: http://auth-service:8070
      FACULTY_SERVICE_URL: http://faculty-service:8080
    ports:
      - "8084:8084"
    depends_on:
      - student-db
      - rabbitmq

  api-gateway:
    build: ./Api-Gateway
    environment:
      AUTH_SERVICE_URL: http://auth-service:8070
      FACULTY_SERVICE_URL: http://faculty-service:8080
      STUDENT_SERVICE_URL: http://student-service:8084
    ports:
      - "8765:8765"
    depends_on:
      - auth-service
      - faculty-service
      - student-service
