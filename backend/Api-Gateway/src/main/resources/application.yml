# ===========================================
# API GATEWAY CONFIGURATION
# ===========================================
spring:
  application:
    name: api-gateway
  
  # Main Web Server Configuration (WebFlux)
  main:
    web-application-type: reactive
  
  cloud:
    gateway:
      # CORS Configuration
      globalcors:
        corsConfigurations:
          '[/**]':
            allowedOriginPatterns:
              - "https://*.vercel.app"
              - "http://localhost:*"
              - "http://localhost:5173"
              - "http://localhost:3000"
            allowedMethods:
              - GET
              - POST
              - PUT
              - DELETE
              - OPTIONS
              - PATCH
            allowedHeaders: "*"
            allowCredentials: true
            maxAge: 3600
      
      # Default Filters for All Routes
      default-filters:
        - DedupeResponseHeader=Access-Control-Allow-Origin Access-Control-Allow-Credentials, RETAIN_UNIQUE
        - name: Retry
          args:
            retries: 3
            statuses: BAD_GATEWAY,GATEWAY_TIMEOUT
            methods: GET
            backoff:
              firstBackoff: 50ms
              maxBackoff: 500ms
      
      # Route Definitions
      routes:
        # =========================================
        # AUTH SERVICE ROUTES
        # =========================================
        # Public Authentication Endpoints
        - id: auth-login
          uri: ${AUTH_SERVICE_URL:http://localhost:8081}
          predicates:
            - Path=/api/auth/login
            - Method=POST
          filters:
            - RewritePath=/api/auth/(?<segment>.*), /auth/$\{segment}
        
        - id: auth-register
          uri: ${AUTH_SERVICE_URL:http://localhost:8081}
          predicates:
            - Path=/api/auth/register
            - Method=POST
          filters:
            - RewritePath=/api/auth/(?<segment>.*), /auth/$\{segment}
        
        - id: auth-token-validation
          uri: ${AUTH_SERVICE_URL:http://localhost:8081}
          predicates:
            - Path=/api/auth/validate,/api/auth/token
            - Method=GET,POST
          filters:
            - RewritePath=/api/auth/(?<segment>.*), /auth/$\{segment}
        
        # Protected Auth Routes
        - id: auth-service-protected
          uri: ${AUTH_SERVICE_URL:http://localhost:8081}
          predicates:
            - Path=/api/auth/**
          filters:
            - RewritePath=/api/auth/(?<segment>.*), /auth/$\{segment}
            - AuthenticationFilter
        
        # =========================================
        # FACULTY SERVICE ROUTES (Protected)
        # =========================================
        - id: faculty-service
          uri: ${FACULTY_SERVICE_URL:http://localhost:8082}
          predicates:
            - Path=/api/faculty/**
          filters:
            - RewritePath=/api/faculty/(?<segment>.*), /faculty/$\{segment}
            - AuthenticationFilter
        
        # =========================================
        # STUDENT SERVICE ROUTES (Protected)
        # =========================================
        - id: student-service
          uri: ${STUDENT_SERVICE_URL:http://localhost:8083}
          predicates:
            - Path=/api/students/**  # Changed to plural
          filters:
            - RewritePath=/api/students/(?<segment>.*), /students/$\{segment}
            - AuthenticationFilter

        # PROJECTS SERVICE ROUTES (via Faculty Service)
        - id: projects-service
          uri: ${FACULTY_SERVICE_URL:http://localhost:8082}
          predicates:
            - Path=/api/projects/**
          filters:
            - RewritePath=/api/projects/(?<segment>.*), /projects/$\{segment}
            - AuthenticationFilter

        # NOTIFICATIONS SERVICE ROUTES  
        - id: notifications-service
          uri: ${NOTIFICATION_SERVICE_URL:http://localhost:8084}
          predicates:
            - Path=/api/notifications/**
          filters:
            - RewritePath=/api/notifications/(?<segment>.*), /notifications/$\{segment}
            - AuthenticationFilter

        # STUDENT PROJECT ROUTES (via Student Service)
        - id: student-project-service
          uri: ${STUDENT_SERVICE_URL:http://localhost:8083}
          predicates:
            - Path=/api/studentProject/**
          filters:
            - RewritePath=/api/studentProject/(?<segment>.*), /studentProject/$\{segment}
            - AuthenticationFilter

        # DOCUMENTS/APPLICATIONS ROUTES (determine which service handles these)
        - id: documents-service
          uri: ${STUDENT_SERVICE_URL:http://localhost:8083}  # Or Faculty Service
          predicates:
            - Path=/api/documents/**,/api/applications/**
          filters:
            - RewritePath=/api/(?<segment>.*), /$\{segment}
            - AuthenticationFilter

      
      # HTTP Client Configuration
      httpclient:
        connect-timeout: 5000
        response-timeout: 30s
        pool:
          type: elastic
          max-idle-time: 10s

# ===========================================
# SERVER CONFIGURATION
# ===========================================
server:
  port: ${SERVER_PORT:8080}
  compression:
    enabled: true
    mime-types: application/json,application/xml,text/html,text/xml,text/plain

# ===========================================
# ACTUATOR & HEALTH CHECKS
# ===========================================
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,gateway,refresh
      base-path: /actuator
  endpoint:
    health:
      show-details: always
      probes:
        enabled: true
    gateway:
      access: unrestricted
  health:
    livenessstate:
      enabled: true
    readinessstate:
      enabled: true
  simple:
    metrics:
      export:
        enabled: true

        

        # ===========================================

        # LOGGING CONFIGURATION

        # ===========================================
logging:
  level:
    root: INFO
    com.cls.apigateway: DEBUG
    org.springframework.cloud.gateway: DEBUG
    org.springframework.web.server: DEBUG
    reactor.netty: INFO
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%X{X-Correlation-Id}] [%thread] %-5level %logger{36} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%X{X-Correlation-Id}] [%thread] %-5level %logger{36} - %msg%n"

# ===========================================
# SECURITY CONFIGURATION
# ===========================================
security:
  jwt:
    secret: ${JWT_SECRET}

# ===========================================
# CUSTOM APPLICATION PROPERTIES
# ===========================================
app:
  security:
    public-endpoints:
      - /api/auth/login
      - /api/auth/register
      - /api/auth/validate
      - /api/auth/token
      - /actuator/**
    role-mappings:
      faculty:
        - /api/faculty/**
      student:
        - /api/student/**
